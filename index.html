
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente Financeiro IA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- React, ReactDOM, Babel, and other libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      body {
        font-family: 'Exo 2', sans-serif;
        background-color: #020617;
      }
      .animated-gradient-text {
        background-size: 200% 200%;
        animation: gradient-animation 4s ease infinite;
      }
      @keyframes gradient-animation {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      .animate-in { animation: enter 0.3s ease-out; }
      .fade-in-0 { opacity: 0; animation-name: fade-in; animation-fill-mode: forwards; }
      .zoom-in-95 { transform: scale(0.95); animation-name: zoom-in; animation-fill-mode: forwards;}
      @keyframes enter {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      @keyframes fade-in { from { opacity: 0 } to { opacity: 1 }}
      @keyframes zoom-in { from { transform: scale(0.95) } to { transform: scale(1) }}
      .animate-spin { animation: spin 1s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
       .animate-bounce {
        animation: bounce 1s infinite;
      }
      @keyframes bounce {
        0%, 100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
          transform: translateY(0);
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-950 text-white antialiased">
    <div id="root">
        <!-- App loading state -->
        <div class="min-h-screen bg-slate-950 flex justify-center items-center">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-cyan-400"></div>
        </div>
    </div>
    
    <!-- This is where your entire React application lives -->
    <script type="text/babel">
        // --- Hardcoded Configuration ---
        const APP_CONFIG = {
          supabaseUrl: 'https://gagrzfzqfybyogxpkqjb.supabase.co',
          supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhZ3J6ZnpxZnlieW9neHBrcWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjMyNzksImV4cCI6MjA2OTg5OTI3OX0.3dC7OdtKx5-bBSmNPCvdu9CcWky-noN-ey9FuNbvisI',
          stripePaymentLink: 'https://buy.stripe.com/test_8x23cvae995MaagetU14400',
        };

        const { createClient } = supabase;
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- Supabase Client ---
        const { supabaseUrl, supabaseKey } = APP_CONFIG;
        if (!supabaseUrl || !supabaseKey) {
            throw new Error("As chaves do Supabase não estão configuradas.");
        }
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // --- ICONS ---
        const LoginIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
        );
        const LogoutIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );
        const ChartIcon = ({ className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );
        const PdfIcon = ({ className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );
        const BotIcon = ({ className = "w-8 h-8 text-cyan-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8.25v-1.5m0 7.5v-1.5m0 7.5v-1.5m0-15A9 9 0 1012 21a9 9 0 000-18z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 12a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0z" />
            </svg>
        );
        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const DashboardIcon = ({ className = "w-8 h-8 text-cyan-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            </svg>
        );
        const PlusIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        );
        const BuildingOfficeIcon = ({ className = "h-5 w-5 text-slate-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4h5m-5 4h5m-5-4h.01M9 7h.01M13 7h.01M13 11h.01M13 15h.01" />
            </svg>
        );
        const EmailIcon = ({ className = "h-5 w-5 text-slate-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        );
        const LockClosedIcon = ({ className = "h-5 w-5 text-slate-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
        );
        const PhoneIcon = ({ className = "h-5 w-5 text-slate-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
        );
        const CalendarIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );
        const SettingsIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        const ClipboardListIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
        );
        const TrashIcon = ({ className = "h-5 w-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const UploadIcon = ({ className = "h-4 w-4" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );
        const PencilIcon = ({ className = "h-5 w-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
            </svg>
        );
        const CloseIcon = ({ className = "h-5 w-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const SparklesIcon = ({ className = "w-8 h-8 text-cyan-400" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" />
            </svg>
        );

        // --- AI Service ---
        const getCategoryFromAI = async (description) => {
            if (!description) return "Outros";
            try {
                const { data, error } = await supabaseClient.functions.invoke('categorize-transaction', {
                    body: { description },
                });
                if (error) throw error;
                return data.category || "Outros";
            } catch (error) {
                console.error("AI Categorization Error:", error);
                return "Outros";
            }
        };

        // --- All other components ---

        const ChartView = ({ transactions }) => {
            if (!window.Recharts) {
                return <div className="text-center text-slate-400 p-8">Carregando gráfico...</div>;
            }
            
            const { ResponsiveContainer, BarChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Bar } = window.Recharts;
            
            const data = useMemo(() => {
                const monthlyData = {};
                transactions.forEach(t => {
                    const month = new Date(t.date).toLocaleString('default', { month: 'short', year: 'numeric' });
                    if (!monthlyData[month]) {
                        monthlyData[month] = { name: month, Receita: 0, Despesa: 0 };
                    }
                    if (t.type === 'Receita') {
                        monthlyData[month].Receita += t.amount;
                    } else {
                        monthlyData[month].Despesa += t.amount;
                    }
                });
                return Object.values(monthlyData).sort((a,b) => new Date(a.name) - new Date(b.name));
            }, [transactions]);

            const CustomTooltip = ({ active, payload, label }) => {
              if (active && payload && payload.length) {
                return (
                  <div className="bg-slate-700/80 backdrop-blur-sm border border-slate-600 p-3 rounded-lg shadow-lg">
                    <p className="font-bold text-white">{label}</p>
                    <p className="text-green-400">{`Receita: ${payload[0].value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`}</p>
                    <p className="text-red-400">{`Despesa: ${payload[1].value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`}</p>
                  </div>
                );
              }
              return null;
            };

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm h-[400px]">
                    <h3 className="text-lg font-bold text-white mb-4">Resumo Anual</h3>
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                            <XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                            <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `R$${value/1000}k`} />
                            <Tooltip content={<CustomTooltip />} cursor={{ fill: 'rgba(100, 116, 139, 0.1)' }}/>
                            <Legend wrapperStyle={{fontSize: "14px"}} />
                            <Bar dataKey="Receita" fill="#22c55e" radius={[4, 4, 0, 0]} />
                            <Bar dataKey="Despesa" fill="#ef4444" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        };
        
        const PdfExporterView = ({ transactions, profile, isPro, onUpgradeRequest }) => {
            const exportPDF = () => {
                if (!isPro) {
                    onUpgradeRequest("Exporte relatórios em PDF com o plano PRO.");
                    return;
                }

                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert("A biblioteca de exportação PDF ainda não está carregada. Tente novamente em alguns segundos.");
                    return;
                }
                const { jsPDF } = window.jspdf;

                if (typeof jsPDF.API.autoTable !== 'function') {
                    alert("A extensão de tabelas para PDF (autoTable) não está carregada. Tente novamente.");
                    return;
                }
                
                const doc = new jsPDF();
                const tableColumn = ["Data", "Descrição", "Categoria", "Tipo", "Valor"];
                const tableRows = [];

                transactions.forEach(t => {
                    const transactionData = [
                        new Date(t.date).toLocaleDateString('pt-BR'),
                        t.description,
                        t.category,
                        t.type,
                        t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                    ];
                    tableRows.push(transactionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 20,
                });
                doc.text(`Relatório Financeiro - ${profile?.company_name || 'Empresa'}`, 14, 15);
                doc.save(`relatorio_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                    <h3 className="text-lg font-bold text-white mb-4">Exportar Relatório</h3>
                    <button onClick={exportPDF} className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg shadow-cyan-500/20">
                        <PdfIcon />
                        Exportar para PDF
                    </button>
                </div>
            );
        };

        const TransactionsView = ({ transactions, onAddTransaction, onUpdateTransaction, onDeleteTransaction, isPro, onUpgradeRequest }) => {
            const [editingTransaction, setEditingTransaction] = useState(null);
            const fileInputRef = useRef(null);

            const handleImportClick = () => {
                if (!isPro) {
                    onUpgradeRequest("Importe planilhas com o plano PRO para agilizar seus lançamentos.");
                    return;
                }
                fileInputRef.current.click();
            };
            
            const handleFileImport = (e) => {
                if (!window.XLSX) {
                    alert("A biblioteca de importação de planilhas não está carregada. Tente novamente em alguns segundos.");
                    e.target.value = null; // Reset file input
                    return;
                }
                
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = event.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        
                        const newTransactions = json.map(row => ({
                            date: new Date(row.Data).toISOString().slice(0,10),
                            description: row.Descricao,
                            amount: parseFloat(row.Valor),
                            type: row.Tipo,
                            category: row.Categoria || "Outros",
                        }));

                        newTransactions.forEach(onAddTransaction);

                    } catch(error) {
                        console.error("Erro ao importar planilha:", error);
                        alert("Ocorreu um erro ao ler o arquivo. Verifique se o formato está correto (Data, Descricao, Valor, Tipo, Categoria).");
                    }
                };
                reader.onerror = (error) => {
                    console.error("Erro no leitor de arquivo:", error);
                    alert("Não foi possível ler o arquivo.");
                };
                reader.readAsBinaryString(file);
                e.target.value = null; // Reset file input to allow re-uploading the same file
            };

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-white">Últimos Lançamentos</h3>
                        <div>
                            <input type="file" accept=".xlsx, .xls" ref={fileInputRef} onChange={handleFileImport} className="hidden" />
                            <button onClick={handleImportClick} className="flex items-center gap-2 text-sm bg-slate-700 hover:bg-slate-600 text-cyan-300 font-semibold py-1 px-3 rounded-md transition-colors">
                                <UploadIcon />
                                Importar Planilha
                            </button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-300">
                             <thead className="text-xs text-slate-400 uppercase bg-slate-800/50">
                                <tr>
                                    <th scope="col" className="px-4 py-3">Data</th>
                                    <th scope="col" className="px-4 py-3">Descrição</th>
                                    <th scope="col" className="px-4 py-3">Categoria</th>
                                    <th scope="col" className="px-4 py-3 text-right">Valor</th>
                                    <th scope="col" className="px-4 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {transactions.map(t => (
                                    <tr key={t.id} className="border-b border-slate-700 hover:bg-slate-800/30">
                                        <td className="px-4 py-3">{new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                        <td className="px-4 py-3 font-medium text-white">{t.description}</td>
                                        <td className="px-4 py-3"><span className="bg-slate-700 text-slate-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">{t.category}</span></td>
                                        <td className={`px-4 py-3 text-right font-bold ${t.type === 'Receita' ? 'text-green-400' : 'text-red-400'}`}>
                                            {t.type === 'Receita' ? '+' : '-'} {t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                          <div className="flex items-center justify-center gap-2">
                                            <button onClick={() => setEditingTransaction(t)} className="p-1 text-slate-400 hover:text-cyan-400 transition-colors"><PencilIcon /></button>
                                            <button onClick={() => onDeleteTransaction(t.id)} className="p-1 text-slate-400 hover:text-red-500 transition-colors"><TrashIcon /></button>
                                          </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {editingTransaction && (
                        <EditTransactionModal
                            transaction={editingTransaction}
                            onClose={() => setEditingTransaction(null)}
                            onSave={onUpdateTransaction}
                        />
                    )}
                </div>
            );
        };

        const AddTransactionForm = ({ onAddTransaction }) => {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [type, setType] = useState('Despesa');
            const [isAiLoading, setIsAiLoading] = useState(false);

            const handleDescriptionBlur = async () => {
              if (description.length > 3 && type === 'Despesa') {
                setIsAiLoading(true);
                await getCategoryFromAI(description); // The result is not used here directly, just warming it up.
                setIsAiLoading(false);
              }
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsAiLoading(true);
                const category = type === 'Despesa' ? await getCategoryFromAI(description) : 'Renda';
                onAddTransaction({ description, amount: parseFloat(amount), date, type, category });
                setDescription('');
                setAmount('');
                setIsAiLoading(false);
            };

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                    <h3 className="text-lg font-bold text-white mb-4">Adicionar Lançamento</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="flex gap-2 mb-2">
                            <button type="button" onClick={() => setType('Receita')} className={`w-full py-2 rounded-md transition-colors text-sm font-bold ${type === 'Receita' ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>Receita</button>
                            <button type="button" onClick={() => setType('Despesa')} className={`w-full py-2 rounded-md transition-colors text-sm font-bold ${type === 'Despesa' ? 'bg-red-500 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>Despesa</button>
                        </div>
                        <div>
                            <label htmlFor="description" className="text-sm font-medium text-slate-400 block mb-1">Descrição</label>
                            <input type="text" id="description" value={description} onChange={e => setDescription(e.target.value)} onBlur={handleDescriptionBlur} placeholder="Ex: Almoço com cliente" className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent"/>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label htmlFor="amount" className="text-sm font-medium text-slate-400 block mb-1">Valor (R$)</label>
                                <input type="number" step="0.01" id="amount" value={amount} onChange={e => setAmount(e.target.value)} placeholder="150.50" className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent"/>
                            </div>
                             <div className="flex-1">
                                <label htmlFor="date" className="text-sm font-medium text-slate-400 block mb-1">Data</label>
                                <input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent"/>
                            </div>
                        </div>
                        <button type="submit" disabled={!description || !amount || isAiLoading} className="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg shadow-cyan-500/20 disabled:from-slate-600 disabled:to-slate-700 disabled:cursor-not-allowed">
                            {isAiLoading && <div className="w-5 h-5 border-2 border-dashed rounded-full animate-spin border-white"></div>}
                            Adicionar
                        </button>
                    </form>
                </div>
            );
        };
        
        const CalendarView = ({ tasks, onAddTask, onUpdateTask, onDeleteTask }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [newTaskDesc, setNewTaskDesc] = useState('');
            const [selectedDay, setSelectedDay] = useState(null);

            const daysInMonth = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const days = [];
                while (date.getMonth() === month) {
                    days.push(new Date(date));
                    date.setDate(date.getDate() + 1);
                }
                return days;
            }, [currentDate]);

            const firstDayOfMonth = useMemo(() => daysInMonth[0].getDay(), [daysInMonth]);

            const handleAddTask = () => {
              if (newTaskDesc.trim() && selectedDay) {
                  onAddTask({
                      date: selectedDay,
                      description: newTaskDesc.trim(),
                      status: 'A Fazer'
                  });
                  setNewTaskDesc('');
              }
            };

            const taskStatusOptions = ['A Fazer', 'Em Andamento', 'Finalizada'];
            const statusColors = {
                'A Fazer': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30',
                'Em Andamento': 'bg-blue-500/20 text-blue-300 border-blue-500/30',
                'Finalizada': 'bg-green-500/20 text-green-300 border-green-500/30',
            };

            const tasksByDay = useMemo(() => {
                return tasks.reduce((acc, task) => {
                    const day = task.date.split('T')[0];
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(task);
                    return acc;
                }, {});
            }, [tasks]);

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))}>&lt;</button>
                        <h3 className="text-lg font-bold text-white">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))}>&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                        {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(day => <div key={day}>{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7 gap-1">
                        {Array(firstDayOfMonth).fill(null).map((_, i) => <div key={`empty-${i}`}></div>)}
                        {daysInMonth.map(day => {
                            const dayString = day.toISOString().split('T')[0];
                            const dayTasks = tasksByDay[dayString] || [];
                            const isSelected = selectedDay === dayString;
                            return (
                                <div key={day.toString()} onClick={() => setSelectedDay(dayString)} className={`h-24 p-1 border rounded-md cursor-pointer transition-all ${isSelected ? 'bg-slate-700 border-cyan-500' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-700/80'}`}>
                                    <div className="font-bold text-sm text-center">{day.getDate()}</div>
                                    <div className="text-xs space-y-1 mt-1">
                                        {dayTasks.slice(0, 2).map(task => (
                                           <div key={task.id} className={`truncate p-0.5 rounded-sm ${statusColors[task.status].split(' ')[0]}`}></div>
                                        ))}
                                        {dayTasks.length > 2 && <div className="text-center text-slate-500 text-[10px]">+ {dayTasks.length - 2}</div>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    {selectedDay && (
                        <div className="mt-4 pt-4 border-t border-slate-700">
                            <h4 className="font-bold text-white mb-2">Tarefas para {new Date(selectedDay).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</h4>
                             <div className="space-y-2 mb-4 max-h-48 overflow-y-auto pr-2">
                                {(tasksByDay[selectedDay] || []).map(task => (
                                    <div key={task.id} className={`flex items-center justify-between p-2 rounded-lg border ${statusColors[task.status]}`}>
                                        <p className="text-sm">{task.description}</p>
                                        <div className="flex items-center gap-2">
                                            <select
                                                value={task.status}
                                                onChange={(e) => onUpdateTask({ ...task, status: e.target.value })}
                                                className="bg-transparent text-xs p-1 rounded-md border-0 focus:ring-0 focus:outline-none"
                                            >
                                                {taskStatusOptions.map(opt => <option key={opt} value={opt} className="bg-slate-800">{opt}</option>)}
                                            </select>
                                             <button onClick={() => onDeleteTask(task.id)} className="text-slate-500 hover:text-red-400 transition-colors"><TrashIcon className="h-4 w-4"/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={newTaskDesc}
                                    onChange={(e) => setNewTaskDesc(e.target.value)}
                                    placeholder="Adicionar nova tarefa..."
                                    className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent"
                                />
                                <button onClick={handleAddTask} className="bg-cyan-500 text-white p-2 rounded-lg hover:bg-cyan-600"><PlusIcon/></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const EditTransactionModal = ({ transaction, onClose, onSave }) => {
            const [edited, setEdited] = useState(transaction);

            const handleSave = () => {
                onSave(edited);
                onClose();
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setEdited(prev => ({ ...prev, [name]: name === 'amount' ? parseFloat(value) : value }));
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 animate-in fade-in-0">
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 w-full max-w-md mx-4 animate-in zoom-in-95">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-white">Editar Lançamento</h3>
                            <button onClick={onClose} className="p-1 text-slate-400 hover:text-white"><CloseIcon /></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label htmlFor="edit_description" className="text-sm font-medium text-slate-400 block mb-1">Descrição</label>
                                <input type="text" id="edit_description" name="description" value={edited.description} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label htmlFor="edit_amount" className="text-sm font-medium text-slate-400 block mb-1">Valor (R$)</label>
                                    <input type="number" step="0.01" id="edit_amount" name="amount" value={edited.amount} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                                </div>
                                 <div className="flex-1">
                                    <label htmlFor="edit_date" className="text-sm font-medium text-slate-400 block mb-1">Data</label>
                                    <input type="date" id="edit_date" name="date" value={edited.date} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                                </div>
                            </div>
                             <div>
                                <label htmlFor="edit_category" className="text-sm font-medium text-slate-400 block mb-1">Categoria</label>
                                <input type="text" id="edit_category" name="category" value={edited.category} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                            </div>
                        </div>
                        <div className="mt-6 flex justify-end gap-3">
                             <button onClick={onClose} className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                             <button onClick={handleSave} className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar Alterações</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ profile, onUpdateProfile, onLogout }) => {
            const [localProfile, setLocalProfile] = useState(profile);

            useEffect(() => {
                setLocalProfile(profile);
            }, [profile]);

            const handleChange = (e) => {
                setLocalProfile({ ...localProfile, [e.target.name]: e.target.value });
            };

            const handleSave = () => {
                onUpdateProfile(localProfile);
            };

            return (
                <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-white">Configurações do Perfil</h3>
                        <p className="text-sm text-slate-400">Atualize as informações da sua empresa.</p>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="company_name" className="text-sm font-medium text-slate-400 block mb-1">Nome da Empresa</label>
                            <input type="text" id="company_name" name="company_name" value={localProfile?.company_name || ''} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                        </div>
                        <div>
                            <label htmlFor="phone" className="text-sm font-medium text-slate-400 block mb-1">Telefone</label>
                            <input type="tel" id="phone" name="phone" value={localProfile?.phone || ''} onChange={handleChange} className="w-full bg-slate-700 rounded-lg py-2 px-3 text-white"/>
                        </div>
                    </div>
                     <div className="flex justify-between items-center pt-6 border-t border-slate-700">
                        <button onClick={onLogout} className="flex items-center gap-2 text-sm text-red-400 hover:text-red-300 transition-colors font-semibold">
                            <LogoutIcon />
                            Sair da Conta
                        </button>
                        <button onClick={handleSave} className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar</button>
                    </div>
                </div>
            );
        };
        
        const UpgradeModal = ({ onClose, message }) => {
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 animate-in fade-in-0">
                    <div className="relative bg-slate-900 border border-cyan-500/50 rounded-2xl p-8 w-full max-w-md mx-4 animate-in zoom-in-95 text-center shadow-2xl shadow-cyan-900/50">
                         <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                            <CloseIcon />
                        </button>
                        <div className="flex justify-center mb-4">
                            <SparklesIcon className="w-12 h-12 text-cyan-400"/>
                        </div>
                        <h3 className="text-2xl font-bold text-white">Desbloqueie o Plano PRO</h3>
                        <p className="text-slate-400 mt-2 mb-6">{message || 'Tenha acesso a todos os recursos com o plano PRO.'}</p>
                        <a href={APP_CONFIG.stripePaymentLink} className="w-full block bg-gradient-to-r from-green-500 to-cyan-500 hover:from-green-600 hover:to-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-all text-lg shadow-lg shadow-cyan-500/20">
                            Fazer Upgrade Agora
                        </a>
                    </div>
                </div>
            );
        };

        // --- Layout Components ---

        const Sidebar = ({ view, setView }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: DashboardIcon },
                { id: 'transactions', label: 'Lançamentos', icon: ClipboardListIcon },
                { id: 'calendar', label: 'Calendário', icon: CalendarIcon },
                { id: 'charts', label: 'Gráficos', icon: ChartIcon },
                { id: 'export', label: 'Exportar', icon: PdfIcon },
                { id: 'settings', label: 'Configurações', icon: SettingsIcon },
            ];

            return (
                <aside className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col items-center gap-4">
                    <div className="p-3 bg-slate-800 rounded-full border border-slate-700 mb-4">
                       <BotIcon className="w-8 h-8 text-cyan-400"/>
                    </div>
                    {navItems.map(item => (
                        <button
                            key={item.id}
                            onClick={() => setView(item.id)}
                            className={`p-3 rounded-xl transition-colors w-full ${view === item.id ? 'bg-cyan-500/20 text-cyan-300' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                            title={item.label}
                        >
                            <item.icon className="w-6 h-6 mx-auto" />
                        </button>
                    ))}
                </aside>
            );
        };

        const MembersArea = ({ user }) => {
            const [view, setView] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showUpgradeModal, setShowUpgradeModal] = useState(false);
            const [upgradeMessage, setUpgradeMessage] = useState('');

            const isPro = useMemo(() => profile?.is_pro || false, [profile]);

            const triggerUpgrade = (message) => {
                if (!isPro) {
                    setUpgradeMessage(message);
                    setShowUpgradeModal(true);
                }
            };

            const fetchData = useCallback(async () => {
                if (!user) return;
                setLoading(true);
                const [transRes, tasksRes, profileRes] = await Promise.all([
                    supabaseClient.from('transactions').select('*').order('date', { ascending: false }),
                    supabaseClient.from('tasks').select('*').order('date', { ascending: false }),
                    supabaseClient.from('profiles').select('*').single()
                ]);

                if (transRes.data) setTransactions(transRes.data);
                if (tasksRes.data) setTasks(tasksRes.data);
                if (profileRes.data) setProfile(profileRes.data);
                
                setLoading(false);
            }, [user]);

            useEffect(() => {
                fetchData();

                const profileListener = supabaseClient.channel('public:profiles')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles', filter: `id=eq.${user.id}` }, payload => {
                        setProfile(payload.new);
                    })
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(profileListener);
                };
            }, [user, fetchData]);
            
            // CRUD Handlers
            const handleAddTransaction = async (newTransaction) => {
                if (!isPro) {
                    const expenseCount = transactions.filter(t => t.type === 'Despesa').length;
                    const revenueCount = transactions.filter(t => t.type === 'Receita').length;

                    if (newTransaction.type === 'Despesa' && expenseCount >= 5) {
                        triggerUpgrade('Você atingiu o limite de 5 despesas do plano gratuito. Faça o upgrade para lançamentos ilimitados!');
                        return;
                    }
                    if (newTransaction.type === 'Receita' && revenueCount >= 3) {
                        triggerUpgrade('Você atingiu o limite de 3 receitas do plano gratuito. Faça o upgrade para lançamentos ilimitados!');
                        return;
                    }
                }

                const { data, error } = await supabaseClient
                    .from('transactions')
                    .insert({ ...newTransaction, user_id: user.id })
                    .select()
                    .single();
                if (data) setTransactions(prev => [data, ...prev]);
            };

            const handleUpdateTransaction = async (updatedTransaction) => {
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .update(updatedTransaction)
                    .eq('id', updatedTransaction.id)
                    .select()
                    .single();
                if (data) setTransactions(prev => prev.map(t => t.id === data.id ? data : t));
            };

            const handleDeleteTransaction = async (id) => {
                await supabaseClient.from('transactions').delete().eq('id', id);
                setTransactions(prev => prev.filter(t => t.id !== id));
            };
            
            const handleAddTask = async (newTask) => {
                 if (!isPro && tasks.length >= 2) {
                    triggerUpgrade('Você atingiu o limite de 2 tarefas do plano gratuito. Faça o upgrade para criar tarefas ilimitadas!');
                    return;
                }
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .insert({ ...newTask, user_id: user.id })
                    .select()
                    .single();
                if (data) setTasks(prev => [data, ...prev]);
            };

            const handleUpdateTask = async (updatedTask) => {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .update(updatedTask)
                    .eq('id', updatedTask.id)
                    .select()
                    .single();
                if (data) setTasks(prev => prev.map(t => t.id === data.id ? data : t));
            };

            const handleDeleteTask = async (id) => {
                await supabaseClient.from('tasks').delete().eq('id', id);
                setTasks(prev => prev.filter(t => t.id !== id));
            };

            const handleUpdateProfile = async (updatedProfile) => {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .update(updatedProfile)
                    .eq('id', user.id)
                    .select()
                    .single();
                if (data) setProfile(data);
            };

            const handleLogout = () => {
                supabaseClient.auth.signOut();
            };

            const summary = useMemo(() => {
                return transactions.reduce((acc, t) => {
                    if (t.type === 'Receita') acc.receitas += t.amount;
                    else acc.despesas += t.amount;
                    return acc;
                }, { receitas: 0, despesas: 0, saldo: 0 });
            }, [transactions]);
            summary.saldo = summary.receitas - summary.despesas;
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-950 flex justify-center items-center">
                        <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-cyan-400"></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-6 lg:p-8 flex gap-8">
                    {showUpgradeModal && <UpgradeModal onClose={() => setShowUpgradeModal(false)} message={upgradeMessage} />}
                    <Sidebar view={view} setView={setView} />
                    <main className="flex-1 space-y-8">
                        {view === 'dashboard' && (
                            <>
                                <header>
                                    <h1 className="text-3xl font-bold text-white">Olá, {profile?.company_name}!</h1>
                                    <p className="text-slate-400">Bem-vindo(a) ao seu painel financeiro.</p>
                                </header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                                        <h4 className="text-sm font-semibold text-green-400">Total de Receitas</h4>
                                        <p className="text-3xl font-bold text-white">{summary.receitas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    </div>
                                     <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                                        <h4 className="text-sm font-semibold text-red-400">Total de Despesas</h4>
                                        <p className="text-3xl font-bold text-white">{summary.despesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    </div>
                                     <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
                                        <h4 className="text-sm font-semibold text-cyan-400">Saldo Atual</h4>
                                        <p className="text-3xl font-bold text-white">{summary.saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2">
                                        <AddTransactionForm onAddTransaction={handleAddTransaction} />
                                    </div>
                                    <div className="lg:col-span-1">
                                        <TransactionsView
                                            transactions={transactions.slice(0, 5)}
                                            onUpdateTransaction={handleUpdateTransaction}
                                            onDeleteTransaction={handleDeleteTransaction}
                                            isPro={isPro}
                                            onUpgradeRequest={triggerUpgrade}
                                        />
                                    </div>
                                </div>
                            </>
                        )}
                        {view === 'transactions' && <TransactionsView transactions={transactions} onAddTransaction={handleAddTransaction} onUpdateTransaction={handleUpdateTransaction} onDeleteTransaction={handleDeleteTransaction} isPro={isPro} onUpgradeRequest={triggerUpgrade} />}
                        {view === 'calendar' && <CalendarView tasks={tasks} onAddTask={handleAddTask} onUpdateTask={handleUpdateTask} onDeleteTask={handleDeleteTask}/>}
                        {view === 'charts' && <ChartView transactions={transactions} />}
                        {view === 'export' && <PdfExporterView transactions={transactions} profile={profile} isPro={isPro} onUpgradeRequest={triggerUpgrade} />}
                        {view === 'settings' && <SettingsView profile={profile} onUpdateProfile={handleUpdateProfile} onLogout={handleLogout}/>}

                    </main>
                </div>
            );
        };
        
        const DashboardPreview = () => {
            const fakeTransactions = [
                { type: 'Receita', desc: 'Projeto de Design', amount: 'R$ 3.500,00' },
                { type: 'Despesa', desc: 'Assinatura de Software', amount: '- R$ 150,00' },
                { type: 'Despesa', desc: 'Material de Escritório', amount: '- R$ 275,80' },
                { type: 'Receita', desc: 'Consultoria', amount: 'R$ 1.200,00' },
            ];
            return (
                <div className="bg-slate-900/70 border border-slate-700 rounded-2xl p-6 shadow-2xl shadow-cyan-900/30 backdrop-blur-sm">
                    <div className="flex items-center gap-2 mb-6">
                        <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                        <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="bg-slate-800 p-4 rounded-lg"><h4 className="text-sm text-green-400">Receitas</h4><p className="text-xl font-bold">R$ 4.700,00</p></div>
                        <div className="bg-slate-800 p-4 rounded-lg"><h4 className="text-sm text-red-400">Despesas</h4><p className="text-xl font-bold">R$ 425,80</p></div>
                        <div className="bg-slate-800 p-4 rounded-lg"><h4 className="text-sm text-cyan-400">Saldo</h4><p className="text-xl font-bold">R$ 4.274,20</p></div>
                    </div>
                    <div>
                        <h3 className="font-semibold mb-2">Últimos Lançamentos</h3>
                        <div className="space-y-2">
                            {fakeTransactions.map((t, i) => (
                                <div key={i} className="flex justify-between items-center bg-slate-800/50 p-3 rounded-md">
                                    <span className="font-medium">{t.desc}</span>
                                    <span className={`font-bold ${t.type === 'Receita' ? 'text-green-400' : 'text-red-400'}`}>{t.amount}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginPage = ({ onBack, setView }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password,
                });
                if (error) {
                    setError(error.message);
                }
                setLoading(false);
            };

            return (
                 <div className="min-h-screen flex flex-col justify-center items-center p-4 animate-in fade-in-0">
                     <div className="w-full max-w-md">
                         <div className="text-center mb-8">
                             <BotIcon className="w-12 h-12 mx-auto text-cyan-400 mb-2"/>
                             <h1 className="text-3xl font-bold text-white">Bem-vindo de volta!</h1>
                             <p className="text-slate-400">Acesse sua conta para continuar.</p>
                         </div>
                         <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-8 backdrop-blur-sm space-y-6">
                             <form onSubmit={handleLogin}>
                                <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="email">Email</label>
                                    <div className="relative flex items-center">
                                        <EmailIcon className="w-5 h-5 text-slate-400 absolute left-4"/> 
                                        <input id="email" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent" type="email" value={email} onChange={e => setEmail(e.target.value)} required placeholder="seu@email.com" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="password">Senha</label>
                                    <div className="relative flex items-center">
                                       <LockClosedIcon className="w-5 h-5 text-slate-400 absolute left-4"/>
                                        <input id="password" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 border border-transparent" type="password" value={password} onChange={e => setPassword(e.target.value)} required placeholder="••••••••" />
                                    </div>
                                </div>
                                {error && <p className="text-red-400 text-sm text-center">{error}</p>}
                                <button type="submit" disabled={loading} className="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg shadow-cyan-500/20 disabled:from-slate-600 disabled:to-slate-700 disabled:cursor-not-allowed">
                                     {loading ? <div className="w-5 h-5 border-2 border-dashed rounded-full animate-spin border-white"></div> : 'Entrar'}
                                </button>
                            </form>
                         </div>
                         <p className="text-center text-sm text-slate-400 mt-6">
                            Não tem uma conta?{' '}
                            <button onClick={() => setView('register')} className="font-semibold text-cyan-400 hover:underline">Crie uma agora</button>
                         </p>
                     </div>
                 </div>
            );
        };

        const RegisterPage = ({ onBack, setView }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [companyName, setCompanyName] = useState('');
            const [phone, setPhone] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');

            const handleRegister = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            company_name: companyName,
                            phone: phone,
                        },
                    },
                });
                if (error) {
                    setError(error.message);
                } else if (data.user && !data.session) {
                    setMessage('Cadastro realizado! Por favor, verifique seu email para confirmar sua conta.');
                }
                 else if (data.user && data.session) {
                    // Auto-login after confirmation in some cases
                    setMessage('Cadastro realizado com sucesso! Você já está logado.');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col justify-center items-center p-4 animate-in fade-in-0">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <BotIcon className="w-12 h-12 mx-auto text-cyan-400 mb-2"/>
                            <h1 className="text-3xl font-bold text-white">Crie sua Conta Grátis</h1>
                            <p className="text-slate-400">Comece a organizar suas finanças hoje mesmo.</p>
                        </div>
                        <div className="bg-slate-800/40 border border-slate-700 rounded-2xl p-8 backdrop-blur-sm space-y-4">
                            <form onSubmit={handleRegister}>
                               <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="companyName">Nome da Empresa</label>
                                    <div className="relative flex items-center">
                                       <BuildingOfficeIcon className="w-5 h-5 text-slate-400 absolute left-4"/>
                                       <input id="companyName" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="text" value={companyName} onChange={e => setCompanyName(e.target.value)} required placeholder="Sua Empresa LTDA" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="phone">Telefone</label>
                                    <div className="relative flex items-center">
                                       <PhoneIcon className="w-5 h-5 text-slate-400 absolute left-4"/>
                                       <input id="phone" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="tel" value={phone} onChange={e => setPhone(e.target.value)} required placeholder="(XX) XXXXX-XXXX" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="reg_email">Email</label>
                                    <div className="relative flex items-center">
                                       <EmailIcon className="w-5 h-5 text-slate-400 absolute left-4" />
                                       <input id="reg_email" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="email" value={email} onChange={e => setEmail(e.target.value)} required placeholder="seu@email.com" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-sm font-medium text-slate-300 block mb-2" htmlFor="reg_password">Senha</label>
                                    <div className="relative flex items-center">
                                       <LockClosedIcon className="w-5 h-5 text-slate-400 absolute left-4"/>
                                       <input id="reg_password" className="w-full bg-slate-700 rounded-lg py-3 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="password" value={password} onChange={e => setPassword(e.target.value)} required placeholder="Mínimo 6 caracteres" />
                                    </div>
                                </div>
                                {error && <p className="text-red-400 text-sm text-center pt-2">{error}</p>}
                                {message && <p className="text-green-400 text-sm text-center pt-2">{message}</p>}
                                <button type="submit" disabled={loading} className="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-green-500 to-cyan-500 hover:from-green-600 hover:to-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg shadow-cyan-500/20 disabled:from-slate-600 disabled:to-slate-700 disabled:cursor-not-allowed">
                                    {loading ? <div className="w-5 h-5 border-2 border-dashed rounded-full animate-spin border-white"></div> : 'Criar Conta'}
                                </button>
                            </form>
                        </div>
                         <p className="text-center text-sm text-slate-400 mt-6">
                            Já tem uma conta?{' '}
                            <button onClick={() => setView('login')} className="font-semibold text-cyan-400 hover:underline">Faça o login</button>
                         </p>
                    </div>
                </div>
            );
        };
        
        const LandingPage = ({ setView }) => {
            const features = [
              { title: "Controle Financeiro Descomplicado", description: "Registre suas receitas e despesas em nossa plataforma, de forma rápida e intuitiva." },
              { title: "Categorização com IA", description: "Nossa Inteligência Artificial analisa suas despesas e as categoriza automaticamente para você." },
              { title: "Relatórios Inteligentes", description: "Visualize gráficos e relatórios que te ajudam a entender para onde seu dinheiro está indo." },
              { title: "Foco no seu Negócio", description: "Gaste menos tempo com planilhas e mais tempo fazendo o que você ama: crescer sua empresa." },
            ];
          
            return (
              <>
                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-slate-900 via-slate-950 to-black opacity-80 z-0"></div>
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                    <div className="w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse"></div>
                    <div className="w-80 h-80 bg-green-500/10 rounded-full blur-3xl animate-pulse -mt-48 ml-32"></div>
                </div>

                <main className="relative z-10 container mx-auto px-6">
                    <header className="flex justify-between items-center py-6">
                        <div className="flex items-center gap-3">
                           <BotIcon />
                           <span className="text-xl font-bold text-white">Assistente Financeiro IA</span>
                        </div>
                        <button onClick={() => setView('login')} className="flex items-center gap-2 bg-slate-800/50 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors border border-slate-700">
                           <LoginIcon />
                           Login
                        </button>
                    </header>
        
                    <section className="text-center py-20 md:py-32">
                        <h1 className="text-4xl md:text-6xl font-black text-white leading-tight mb-4">
                            Organize suas finanças de forma fácil <br />
                            <span className="bg-gradient-to-r from-green-400 to-cyan-400 text-transparent bg-clip-text animated-gradient-text">com Inteligência Artificial.</span>
                        </h1>
                        <p className="max-w-3xl mx-auto text-lg md:text-xl text-slate-300 mb-8">
                            Chega de planilhas complicadas. Use nosso assistente com Inteligência Artificial para controlar suas finanças de forma simples e intuitiva.
                        </p>
                        <button onClick={() => setView('register')} className="bg-gradient-to-r from-green-500 to-cyan-500 hover:from-green-600 hover:to-cyan-600 text-white font-black text-xl py-4 px-10 rounded-full transition-all shadow-2xl shadow-cyan-500/30 transform hover:scale-105 animate-bounce">
                           Começar Teste Grátis
                        </button>
                    </section>
        
                    <section className="py-16 grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
                       <DashboardPreview />
                        <div className="space-y-8">
                           {features.map((feature, index) => (
                               <div key={index} className="flex items-start gap-4">
                                   <div className="mt-1"><CheckIcon /></div>
                                   <div>
                                       <h3 className="font-bold text-lg text-white">{feature.title}</h3>
                                       <p className="text-slate-400">{feature.description}</p>
                                   </div>
                               </div>
                           ))}
                        </div>
                    </section>
                </main>
              </>
            );
        };


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [session, setSession] = useState(null);
            const [view, setView] = useState('landing'); // 'landing', 'login', 'register'
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    setLoading(false);
                });

                // Check initial session
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (loading) {
                 return (
                    <div className="min-h-screen bg-slate-950 flex justify-center items-center">
                        <div className="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-cyan-400"></div>
                    </div>
                );
            }
            
            if (session) {
                return <MembersArea user={session.user} />;
            }
            
            switch (view) {
                case 'login':
                    return <LoginPage setView={setView} />;
                case 'register':
                    return <RegisterPage setView={setView} />;
                default:
                    return <LandingPage setView={setView} />;
            }
        };

        // Mount the app to the root div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>